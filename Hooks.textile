Cucumber provides a number of hooks which allow us to run blocks at various points in the Cucumber test cycle. You can put them in your <code>support/env.rb</code> file or any other file under the <code>support</code> directory, for example in a file called <code>support/hooks.rb</code>. There is no association between where the hook is defined and which scenario/step it is run for, but you can use tagged hooks (see below) if you want more fine grained control.

All defined hooks are run whenever the relevant event occurs.

h2. Scenario hooks

<code>Before</code> hooks will be run before the first step of each scenario. They will run in the same order of which they are registered.

<pre><code>Before do
  # Do something before each scenario.
end
</code></pre>

<code>After</code> hooks will be run after the last step of each scenario, even when there are failing, undefined, pending or skipped steps. They will run in the *opposite* order of which they are registered.

<pre><code>After do |scenario|
  # Do something after each scenario.
  # The +scenario+ argument is optional, but
  # if you use it, you can inspect status with
  # the #failed?, #passed? and #exception methods.

  if(scenario.failed?)
    subject = "[Project X] #{scenario.exception.message}"
    send_failure_email(subject)
  end
end
</code></pre>

<code>Around</code> hooks will run "around" a scenario. This can be used to wrap the execution a scenario in a block. The Around hook receives a scenario object and a block (Proc) object. The scenario will be executed when you invoke <code>block.call</code>.

The following example will cause scenarios tagged with <code>@fast</code> to fail if the execution takes longer than 0.5 seconds:

<pre><code>Around('@fast') do |scenario, block|
  Timeout.timeout(0.5) do
    block.call
  end
end
</code></pre>

You may want to take a look at "SystemTimer":http://ph7spot.com/musings/system-timer if you want a more reliable <code>timeout</code>.

h2. Step hooks

*{color:red}Warning: AfterStep hook does not work with scenarios which have backgrounds (cucumber 0.3.11)*

<pre><code>AfterStep do |scenario|
  # Do something after each step.
end
</code></pre>

h2. Tagged hooks

Sometimes you may want a certain hook to run only for certain scenarios. This can be achieved by associating a <code>Before</code>, <code>After</code>, <code>Around</code> or <code>AfterStep</code> hook with one or more [[tags]]. You can OR and AND tags in much the same way as you can when running Cucumber from the command line. Examples: 

To OR tags pass the tags in a single string comma separated:

<pre><code>Before('@cucumis,@sativus') do
  # This will only run before scenarios tagged
  # with @cucumis OR @sativus.
end</code></pre>

To AND tags pass the tags as separate tag strings:

<pre><code>Before('@cucumis', '@sativus') do
  # This will only run before scenarios tagged
  # with @cucumis AND @sativus.
end</code></pre>

You create complex tag conditions using both OR and AND on tags:

<pre><code>Before('@cucumis,@sativus', '@aqua') do
  # This will only run before scenarios tagged
  # with (@cucumis OR @sativus) AND @aqua 
end</code></pre>

After Step example:

<pre><code>AfterStep('@cucumis', '@sativus') do
  # This will only run before steps within scenarios tagged
  # with @cucumis AND @sativus.
end</code></pre>

Think twice before you use this feature, as whatever happens in hooks is invisible to people who only read the features. You should consider using [[background]] as a more explicit alternative if the setup should be readable by non-technical people. 

h2. Global hooks

If you want something to happen once before any scenario is run - just put that code at the top-level in your <code>env.rb</code> file (or any other file in your <code>features/support</code> directory. Use <code>Kernel#at_exit</code> for global teardown. Example:

<pre><code>my_heavy_object = HeavyObject.new
my_heavy_object.do_it

at_exit do
  my_heavy_object.undo_it
end
</code></pre>

You may also provide an <code>AfterConfiguration</code> hook that will be run after Cucumber has been configured. The block you provide will be passed the cucumber configuration (an instance of <code>Cucumber::Cli::Configuration</code>). Example:

<pre><code>AfterConfiguration do |config|
  puts "Features dwell in #{config.feature_dirs}"
end
</code></pre>

This hook will run only once; after support has been loaded but before features are loaded. You can use this hook to extend Cucumber, for example you could affect how features are loaded or register [[custom formatters]] programatically.
